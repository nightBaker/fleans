@using Fleans.Domain

<FluentStack Orientation="Orientation.Vertical" Gap="12px" Style="flex: 2;">
    <FluentStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Justify="JustifyContent.SpaceBetween">
        <FluentHeading HSize="HeadingSize.H3">
            @if (SelectedGroup == null)
            {
                <span>Versions</span>
            }
            else
            {
                <span>Versions for @SelectedGroup.ProcessDefinitionKey</span>
            }
        </FluentHeading>

        <FluentButton Appearance="Appearance.Accent"
                      @onclick="StartSelected"
                      Disabled="@(IsStarting || string.IsNullOrWhiteSpace(SelectedProcessDefinitionId))">
            @if (IsStarting && StartingProcessDefinitionId == SelectedProcessDefinitionId)
            {
                <FluentProgressRing Size="Size.Small" />
                <span style="margin-left: 8px;">Starting...</span>
            }
            else
            {
                <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Play())" />
                <span style="margin-left: 8px;">Start selected version</span>
            }
        </FluentButton>
    </FluentStack>

    @if (!HasFilteredKeys)
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            No keys match "@SearchQuery".
        </FluentMessageBar>
    }
    else if (SelectedGroup == null)
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            Select a process key to view its versions.
        </FluentMessageBar>
    }
    else if (SelectedGroup.Versions.Count == 0)
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            No versions found for this key.
        </FluentMessageBar>
    }
    else
    {
        <FluentTable Items="@SelectedGroup.Versions">
            <FluentTableHeader>
                <FluentTableRow>
                    <FluentTableHeaderCell>Version</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Deployed at (UTC)</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Process definition id</FluentTableHeaderCell>
                </FluentTableRow>
            </FluentTableHeader>
            <FluentTableBody>
                @foreach (var version in SelectedGroup.Versions)
                {
                    var isSelected = SelectedProcessDefinitionId == version.ProcessDefinitionId;
                    <FluentTableRow @onclick="() => SelectVersion(version)" Style="@GetRowStyle(isSelected)">
                        <FluentTableCell>
                            <FluentBadge Color="Color.Accent">v@version.Version</FluentBadge>
                        </FluentTableCell>
                        <FluentTableCell>
                            @version.DeployedAt.ToUniversalTime().ToString("u")
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentBodyText>@version.ProcessDefinitionId</FluentBodyText>
                        </FluentTableCell>
                    </FluentTableRow>
                }
            </FluentTableBody>
        </FluentTable>
    }
</FluentStack>

@code {
    [Parameter] public WorkflowGroupVm? SelectedGroup { get; set; }
    [Parameter] public bool HasFilteredKeys { get; set; }
    [Parameter] public string SearchQuery { get; set; } = string.Empty;
    [Parameter] public string? SelectedProcessDefinitionId { get; set; }
    [Parameter] public EventCallback<ProcessDefinitionSummary> OnSelectVersion { get; set; }
    [Parameter] public EventCallback OnStartSelected { get; set; }
    [Parameter] public bool IsStarting { get; set; }
    [Parameter] public string? StartingProcessDefinitionId { get; set; }

    private Task SelectVersion(ProcessDefinitionSummary version) => OnSelectVersion.InvokeAsync(version);

    private Task StartSelected() => OnStartSelected.InvokeAsync();

    private static string GetRowStyle(bool isSelected) =>
        isSelected
            ? "cursor: pointer; background-color: var(--neutral-layer-2);"
            : "cursor: pointer;";
}
