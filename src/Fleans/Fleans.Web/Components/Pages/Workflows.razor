@page "/workflows"
@rendermode InteractiveServer
@using Fleans.Application
@using Fleans.Application.QueryModels
@using Microsoft.FluentUI.AspNetCore.Components
@inject IWorkflowQueryService QueryService
@inject IWorkflowCommandService CommandService
@inject NavigationManager Navigation
@inject ILogger<Workflows> Logger

<PageTitle>Workflows</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Gap="20px" >
    <PageHeader Title="Registered Workflows">
        <Actions>
            <FluentButton Appearance="Appearance.Accent"
                          IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Add())"
                          @onclick="NewWorkflow">
                New Workflow
            </FluentButton>
            <FluentButton Appearance="Appearance.Neutral"
                          IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowSync())"
                          @onclick="RefreshWorkflows"
                          Disabled="@isLoading">
                Refresh
            </FluentButton>
        </Actions>
    </PageHeader>

    @if (isLoading && allRows.Count == 0)
    {
        <FluentStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="10px">
            <FluentProgressRing />
            <p>Loading workflows...</p>
        </FluentStack>
    }
    else
    {
        @if (!string.IsNullOrWhiteSpace(loadErrorMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => loadErrorMessage = null)">
                <FluentStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
                    <span>@loadErrorMessage</span>
                    <FluentButton Appearance="Appearance.Neutral" @onclick="RefreshWorkflows" Disabled="@isLoading">
                        Retry
                    </FluentButton>
                </FluentStack>
            </FluentMessageBar>
        }

        @if (!string.IsNullOrWhiteSpace(actionErrorMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => actionErrorMessage = null)">
                @actionErrorMessage
            </FluentMessageBar>
        }

        @if (!string.IsNullOrWhiteSpace(actionSuccessMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Success" Dismissible="true" OnDismissed="@(() => actionSuccessMessage = null)">
                @actionSuccessMessage
            </FluentMessageBar>
        }

        @if (allRows.Count == 0)
        {
            <FluentMessageBar Intent="MessageIntent.Info">
                <strong>No workflows found.</strong> Create a new workflow in the <a href="/editor">Editor</a>.
            </FluentMessageBar>
        }
        else
        {
            <FluentTextField Placeholder="Search by process key"
                             @bind-Value="SearchQuery"
                             Style="max-width: 320px;" />

            @if (filteredRows.Count == 0)
            {
                <FluentMessageBar Intent="MessageIntent.Info">
                    No workflows match "@SearchQuery".
                </FluentMessageBar>
            }
            else
            {
                <FluentDataGrid Items="@filteredRows.Where(r => !r.IsHidden).AsQueryable()" TGridItem="ProcessDefinitionRow">
                    <TemplateColumn Title="Process Key" HierarchicalToggle="true">
                        <strong title="@context.Item.ProcessDefinitionId">@context.Item.ProcessDefinitionKey</strong>
                    </TemplateColumn>
                    <TemplateColumn Title="Version">
                        <FluentBadge Color="Color.Accent">v@(context.Item.Version)</FluentBadge>
                    </TemplateColumn>
                    <TemplateColumn Title="Deployed at (UTC)">
                        @context.Item.DeployedAt.ToUniversalTime().ToString("u")
                    </TemplateColumn>
                    <TemplateColumn Title="Actions">
                        <FluentStack Orientation="Orientation.Horizontal" Gap="4px">
                            <FluentButton Appearance="Appearance.Stealth"
                                          IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Edit())"
                                          @onclick="() => EditWorkflow(context.Item)">
                                Edit
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Stealth"
                                          IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Play())"
                                          Loading="@(isStarting && startingProcessDefinitionId == context.Item.ProcessDefinitionId)"
                                          Disabled="@isStarting"
                                          @onclick="() => StartVersion(context.Item)">
                                Start
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Stealth"
                                          IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.List())"
                                          @onclick="() => ViewInstances(context.Item)">
                                Instances
                            </FluentButton>
                        </FluentStack>
                    </TemplateColumn>
                </FluentDataGrid>
            }
        }
    }
</FluentStack>

@code {
    private sealed class ProcessDefinitionRow : HierarchicalGridItem<ProcessDefinitionSummary, ProcessDefinitionRow>
    {
    }

    private List<ProcessDefinitionRow> allRows = [];
    private List<ProcessDefinitionRow> filteredRows = [];
    private bool isLoading = true;
    private string? loadErrorMessage;
    private string? actionErrorMessage;
    private string? actionSuccessMessage;
    private bool isStarting = false;
    private string? startingProcessDefinitionId;
    private string searchQuery = string.Empty;

    private string SearchQuery
    {
        get => searchQuery;
        set
        {
            if (searchQuery == value)
            {
                return;
            }

            searchQuery = value;
            ApplyFilter();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflows();
    }

    private async Task LoadWorkflows()
    {
        try
        {
            isLoading = true;
            loadErrorMessage = null;

            var definitions = await QueryService.GetAllProcessDefinitions();

            allRows = definitions
                .GroupBy(d => d.ProcessDefinitionKey)
                .OrderBy(g => g.Key, StringComparer.Ordinal)
                .SelectMany(group =>
                {
                    var versions = group.OrderByDescending(d => d.Version).ToList();

                    var parent = new ProcessDefinitionRow
                    {
                        Item = versions[0],
                        IsCollapsed = true,
                    };

                    var children = versions.Skip(1)
                        .Select(d => new ProcessDefinitionRow
                        {
                            Item = d,
                            Depth = 1,
                            IsHidden = true,
                        })
                        .ToList();

                    foreach (var child in children)
                    {
                        parent.Children.Add(child);
                    }

                    return new[] { parent }.Concat(children);
                })
                .ToList();

            ApplyFilter();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading workflows");
            loadErrorMessage = "Unable to reach workflow engine. Try again.";
            if (allRows.Count == 0)
            {
                filteredRows = [];
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshWorkflows()
    {
        await LoadWorkflows();
    }

    private void NewWorkflow()
    {
        Navigation.NavigateTo("/editor");
    }

    private void EditWorkflow(ProcessDefinitionSummary definition)
    {
        Navigation.NavigateTo($"/editor/{Uri.EscapeDataString(definition.ProcessDefinitionKey)}/{definition.Version}");
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(SearchQuery))
        {
            filteredRows = allRows;
        }
        else
        {
            // Include parent + its children when key matches
            var matchingKeys = allRows
                .Where(r => r.Depth == 0
                    && r.Item.ProcessDefinitionKey.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase))
                .Select(r => r.Item.ProcessDefinitionKey)
                .ToHashSet(StringComparer.Ordinal);

            filteredRows = allRows
                .Where(r => matchingKeys.Contains(r.Item.ProcessDefinitionKey))
                .ToList();
        }

    }

    private async Task StartVersion(ProcessDefinitionSummary version)
    {
        try
        {
            isStarting = true;
            startingProcessDefinitionId = version.ProcessDefinitionId;
            actionErrorMessage = null;
            actionSuccessMessage = null;

            var instanceId = await CommandService.StartWorkflowByProcessDefinitionId(version.ProcessDefinitionId);
            Logger.LogInformation("Process definition {ProcessDefinitionId} started successfully with instanceId {WorkflowInstanceId}", version.ProcessDefinitionId, instanceId);
            actionSuccessMessage = $"Started '{version.ProcessDefinitionKey}' v{version.Version}. Instance: {instanceId}.";
        }
        catch (KeyNotFoundException ex)
        {
            Logger.LogWarning("Failed to start process definition {ProcessDefinitionId}: {Error}", version.ProcessDefinitionId, ex.Message);
            actionErrorMessage = $"Failed to start workflow: {ex.Message}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting process definition {ProcessDefinitionId}", version.ProcessDefinitionId);
            actionErrorMessage = $"Failed to start workflow: {ex.Message}";
        }
        finally
        {
            isStarting = false;
            startingProcessDefinitionId = null;
        }
    }

    private void ViewInstances(ProcessDefinitionSummary version)
    {
        Navigation.NavigateTo($"/process-instances/{Uri.EscapeDataString(version.ProcessDefinitionKey)}/{version.Version}");
    }
}
