@page "/workflows"
@rendermode InteractiveServer
@using Fleans.Application
@using Fleans.Application.WorkflowFactory
@using Fleans.Domain
@using Fleans.Infrastructure.Bpmn
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.FluentUI.AspNetCore.Components
@inject WorkflowEngine WorkflowEngine
@inject IBpmnConverter BpmnConverter
@inject ILogger<Workflows> Logger

<PageTitle>Workflows</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Gap="20px">
    <FluentStack Orientation="Orientation.Horizontal" Justify="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <FluentHeader HSize="HeadingSize.H1">Registered Workflows</FluentHeader>
        
        <FluentStack Orientation="Orientation.Vertical" Gap="20px">
            <FluentInputFile @ref="@myFileUploader" 
                             DragDropZoneVisible="false"
                             Mode="InputFileMode.SaveToTemporaryFolder"
                             Multiple="false"
                             AnchorId="MyUploadButton"
                             MaximumFileSize="@(10 * 1024 * 1024)"
                             Accept=".bpmn,.xml"
                             OnProgressChange="@(e =>
                                               {
                                                   uploadProgressPercent = e.ProgressPercent; 
                                                   uploadProgressTitle = e.ProgressTitle;
                                               })"
                             OnCompleted="@OnFileUploadCompleted" />

            <FluentProgress Min="0" Max="100" Visible="@(uploadProgressPercent > 0)" Value="@uploadProgressPercent" />
            @if (!string.IsNullOrEmpty(uploadProgressTitle))
            {
                <FluentLabel Alignment="HorizontalAlignment.Center">
                    @uploadProgressTitle
                </FluentLabel>
            }

            <FluentButton Id="MyUploadButton" Appearance="Appearance.Accent" Disabled="@isUploading">
                <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowUpload())" />
                <span style="margin-left: 8px;">Select BPMN File</span>
            </FluentButton>

            @if (uploadedFiles.Any())
            {
                <FluentStack Orientation="Orientation.Vertical" Gap="10px">
                    <FluentHeading HSize="HeadingSize.H4">Selected file:</FluentHeading>
                    @foreach (var file in uploadedFiles)
                    {
                        <FluentBodyText>
                            <strong>@file.Name</strong> • 
                            @($"{Decimal.Divide(file.Size, 1024):N} KB") • 
                            @file.ContentType
                            @if (!string.IsNullOrEmpty(file.ErrorMessage))
                            {
                                <FluentMessageBar Intent="MessageIntent.Error">@file.ErrorMessage</FluentMessageBar>
                            }
                        </FluentBodyText>
                    }
                    <FluentButton Appearance="Appearance.Accent" @onclick="HandleFileUpload" Disabled="@isUploading">
                        @if (isUploading)
                        {
                            <FluentProgressRing Size="Size.Small" />
                            <span style="margin-left: 8px;">Uploading...</span>
                        }
                        else
                        {
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowUpload())" />
                            <span style="margin-left: 8px;">Deploy workflow</span>
                        }
                    </FluentButton>
                </FluentStack>
            }

            @if (uploadErrorMessage != null)
            {
                <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => uploadErrorMessage = null)">
                    @uploadErrorMessage
                </FluentMessageBar>
            }
            @if (uploadSuccessMessage != null)
            {
                <FluentMessageBar Intent="MessageIntent.Success" Dismissible="true" OnDismissed="@(() => uploadSuccessMessage = null)">
                    @uploadSuccessMessage
                </FluentMessageBar>
            }
        </FluentStack>
        
    </FluentStack>

    @if (isLoading)
    {
        <FluentStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="10px">
            <FluentProgressRing />
            <FluentBodyText>Loading workflows...</FluentBodyText>
        </FluentStack>
    }
    else if (errorMessage != null)
    {
        <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => errorMessage = null)">
            <strong>Error:</strong> @errorMessage
        </FluentMessageBar>
    }
    else if (workflowGroups == null || !workflowGroups.Any())
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            <strong>No workflows found.</strong> Upload a BPMN file to register a workflow.
        </FluentMessageBar>
    }
    else
    {
        <FluentTable Items="@workflowGroups">
            <FluentTableHeader>
                <FluentTableRow>
                    <FluentTableHeaderCell>Process Key</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Latest Version</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Versions</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Activities (latest)</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Sequence Flows (latest)</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Actions</FluentTableHeaderCell>
                </FluentTableRow>
            </FluentTableHeader>
            <FluentTableBody>
                @foreach (var group in workflowGroups)
                {
                    <FluentTableRow>
                        <FluentTableCell>
                            <strong>@group.ProcessDefinitionKey</strong>
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentBadge Color="Color.Accent">v@group.LatestVersion</FluentBadge>
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentBadge Color="Color.Neutral">@group.TotalVersions</FluentBadge>
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentBadge Color="Color.Accent">@group.LatestActivitiesCount</FluentBadge>
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentBadge Color="Color.Neutral">@group.LatestSequenceFlowsCount</FluentBadge>
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
                                <FluentButton Appearance="Appearance.Stealth" @onclick="() => StartLatestWorkflow(group.ProcessDefinitionKey)" Disabled="@isStarting">
                                    @if (isStarting && startingWorkflowKey == group.ProcessDefinitionKey)
                                    {
                                        <FluentProgressRing Size="Size.Small" />
                                        <span style="margin-left: 8px;">Starting latest...</span>
                                    }
                                    else
                                    {
                                        <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Play())" />
                                        <span style="margin-left: 8px;">Start (latest)</span>
                                    }
                                </FluentButton>

                                @if (group.TotalVersions > 1)
                                {
                                    <FluentButton Appearance="Appearance.Neutral" @onclick="() => ToggleOlderVersionPicker(group.ProcessDefinitionKey)" Disabled="@isStarting">
                                        <span>Start older version…</span>
                                    </FluentButton>
                                }
                            </FluentStack>

                            @if (expandedKey == group.ProcessDefinitionKey)
                            {
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                        <label>
                                            <span style="margin-right: 8px;">Version</span>
                                            <select @bind="selectedProcessDefinitionId" class="form-select" style="min-width: 280px;">
                                                @foreach (var v in group.Versions.OrderByDescending(x => x.Version))
                                                {
                                                    <option value="@v.ProcessDefinitionId">v@v.Version — @v.DeployedAt.ToUniversalTime().ToString("u")</option>
                                                }
                                            </select>
                                        </label>

                                        <FluentButton Appearance="Appearance.Accent"
                                                     @onclick="StartSelectedVersion"
                                                     Disabled="@(isStarting || string.IsNullOrWhiteSpace(selectedProcessDefinitionId))">
                                            @if (isStarting && startingProcessDefinitionId == selectedProcessDefinitionId)
                                            {
                                                <FluentProgressRing Size="Size.Small" />
                                                <span style="margin-left: 8px;">Starting...</span>
                                            }
                                            else
                                            {
                                                <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Play())" />
                                                <span style="margin-left: 8px;">Start selected</span>
                                            }
                                        </FluentButton>

                                        <FluentButton Appearance="Appearance.Stealth" @onclick="CollapseOlderVersionPicker" Disabled="@isStarting">
                                            <span>Cancel</span>
                                        </FluentButton>
                                    </div>
                                </div>
                            }
                        </FluentTableCell>
                    </FluentTableRow>
                }
            </FluentTableBody>
        </FluentTable>

        <FluentButton Appearance="Appearance.Neutral" @onclick="RefreshWorkflows" Disabled="@isLoading">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowSync())" />
            Refresh
        </FluentButton>
    }
</FluentStack>



@code {
    private sealed class WorkflowGroupVm
    {
        public required string ProcessDefinitionKey { get; init; }
        public required int LatestVersion { get; init; }
        public required int TotalVersions { get; init; }
        public required int LatestActivitiesCount { get; init; }
        public required int LatestSequenceFlowsCount { get; init; }
        public required List<ProcessDefinitionSummary> Versions { get; init; }
    }

    private List<WorkflowGroupVm>? workflowGroups;
    private bool isLoading = true;
    private string? errorMessage;
    private bool isStarting = false;
    private string? startingWorkflowKey;
    private string? startingProcessDefinitionId;
    private string? expandedKey;
    private string? selectedProcessDefinitionId;
    private bool showUploadModal = false;
    private bool isUploading = false;
    private FluentInputFile? myFileUploader = default!;
    private int? uploadProgressPercent;
    private string? uploadProgressTitle;
    private FluentInputFileEventArgs[] uploadedFiles = Array.Empty<FluentInputFileEventArgs>();
    private string? uploadErrorMessage;
    private string? uploadSuccessMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflows();
    }

    private async Task LoadWorkflows()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var definitions = await WorkflowEngine.GetAllProcessDefinitions();

            workflowGroups = definitions
                .GroupBy(d => d.ProcessDefinitionKey, StringComparer.Ordinal)
                .Select(g =>
                {
                    var ordered = g.OrderBy(d => d.Version).ToList();
                    var latest = ordered[^1];
                    return new WorkflowGroupVm
                    {
                        ProcessDefinitionKey = g.Key,
                        LatestVersion = latest.Version,
                        TotalVersions = ordered.Count,
                        LatestActivitiesCount = latest.ActivitiesCount,
                        LatestSequenceFlowsCount = latest.SequenceFlowsCount,
                        Versions = ordered
                    };
                })
                .OrderBy(g => g.ProcessDefinitionKey, StringComparer.Ordinal)
                .ToList();

            if (expandedKey != null && workflowGroups.All(g => g.ProcessDefinitionKey != expandedKey))
            {
                expandedKey = null;
                selectedProcessDefinitionId = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading workflows");
            errorMessage = "Failed to load workflows. Please try again later.";
            workflowGroups = new List<WorkflowGroupVm>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshWorkflows()
    {
        await LoadWorkflows();
    }

    private async Task StartLatestWorkflow(string processDefinitionKey)
    {
        try
        {
            isStarting = true;
            startingWorkflowKey = processDefinitionKey;
            startingProcessDefinitionId = null;

            var instanceId = await WorkflowEngine.StartWorkflow(processDefinitionKey);
            Logger.LogInformation("Workflow {ProcessDefinitionKey} (latest) started successfully with instanceId {WorkflowInstanceId}", processDefinitionKey, instanceId);
            errorMessage = null;
        }
        catch (KeyNotFoundException ex)
        {
            Logger.LogWarning("Failed to start workflow {ProcessDefinitionKey}: {Error}", processDefinitionKey, ex.Message);
            errorMessage = $"Failed to start workflow: {ex.Message}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting workflow {ProcessDefinitionKey}", processDefinitionKey);
            errorMessage = $"Failed to start workflow: {ex.Message}";
        }
        finally
        {
            isStarting = false;
            startingWorkflowKey = null;
        }
    }

    private void ToggleOlderVersionPicker(string processDefinitionKey)
    {
        if (expandedKey == processDefinitionKey)
        {
            expandedKey = null;
            selectedProcessDefinitionId = null;
            return;
        }

        expandedKey = processDefinitionKey;
        var group = workflowGroups?.FirstOrDefault(g => g.ProcessDefinitionKey == processDefinitionKey);
        selectedProcessDefinitionId = group?.Versions.OrderByDescending(v => v.Version).FirstOrDefault()?.ProcessDefinitionId;
    }

    private void CollapseOlderVersionPicker()
    {
        expandedKey = null;
        selectedProcessDefinitionId = null;
    }

    private async Task StartSelectedVersion()
    {
        if (string.IsNullOrWhiteSpace(selectedProcessDefinitionId))
        {
            errorMessage = "Please select a version to start.";
            return;
        }

        try
        {
            isStarting = true;
            startingProcessDefinitionId = selectedProcessDefinitionId;
            startingWorkflowKey = null;

            var instanceId = await WorkflowEngine.StartWorkflowByProcessDefinitionId(selectedProcessDefinitionId);
            Logger.LogInformation("Process definition {ProcessDefinitionId} started successfully with instanceId {WorkflowInstanceId}", selectedProcessDefinitionId, instanceId);
            errorMessage = null;
        }
        catch (KeyNotFoundException ex)
        {
            Logger.LogWarning("Failed to start process definition {ProcessDefinitionId}: {Error}", selectedProcessDefinitionId, ex.Message);
            errorMessage = $"Failed to start workflow: {ex.Message}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting process definition {ProcessDefinitionId}", selectedProcessDefinitionId);
            errorMessage = $"Failed to start workflow: {ex.Message}";
        }
        finally
        {
            isStarting = false;
            startingProcessDefinitionId = null;
        }
    }

    private void ShowUploadDialog()
    {
        showUploadModal = true;
        uploadErrorMessage = null;
        uploadSuccessMessage = null;
        uploadedFiles = Array.Empty<FluentInputFileEventArgs>();
        uploadProgressPercent = null;
        uploadProgressTitle = null;
        
        StateHasChanged();
    }

    private void HideUploadDialog()
    {
        showUploadModal = false;
        uploadErrorMessage = null;
        uploadSuccessMessage = null;
        uploadedFiles = Array.Empty<FluentInputFileEventArgs>();
        uploadProgressPercent = null;
        uploadProgressTitle = null;
        
        // Clean up temporary files
        foreach (var file in uploadedFiles)
        {
            file.LocalFile?.Delete();
        }
    }

    private void OnFileUploadCompleted(IEnumerable<FluentInputFileEventArgs> files)
    {
        uploadedFiles = files.ToArray();
        uploadProgressPercent = myFileUploader?.ProgressPercent;
        uploadProgressTitle = myFileUploader?.ProgressTitle;
        
        // Check for errors in uploaded files
        var errorFile = uploadedFiles.FirstOrDefault(f => !string.IsNullOrEmpty(f.ErrorMessage));
        if (errorFile != null)
        {
            uploadErrorMessage = errorFile.ErrorMessage;
        }
    }

    private async Task HandleFileUpload()
    {
        if (!uploadedFiles.Any())
        {
            uploadErrorMessage = "Please select a file to upload";
            return;
        }

        var file = uploadedFiles.First();
        
        if (!string.IsNullOrEmpty(file.ErrorMessage))
        {
            uploadErrorMessage = file.ErrorMessage;
            return;
        }

        try
        {
            isUploading = true;
            uploadErrorMessage = null;
            uploadSuccessMessage = null;

            // Validate file extension
            if (!file.Name.EndsWith(".bpmn", StringComparison.OrdinalIgnoreCase) &&
                !file.Name.EndsWith(".xml", StringComparison.OrdinalIgnoreCase))
            {
                uploadErrorMessage = "File must be a BPMN (.bpmn) or XML (.xml) file";
                return;
            }

            // Read file from temporary location
            if (file.LocalFile == null || !file.LocalFile.Exists)
            {
                uploadErrorMessage = "File not found. Please select the file again.";
                return;
            }

            using var fileStream = file.LocalFile.OpenRead();
            var workflow = await BpmnConverter.ConvertFromXmlAsync(fileStream);
            
            // Deploy workflow (Camunda-like: every deploy creates a new version per BPMN process id)
            var deployed = await WorkflowEngine.DeployWorkflow(workflow);
            
            uploadSuccessMessage = $"BPMN deployed successfully (Key: {deployed.ProcessDefinitionKey}, Version: v{deployed.Version}, Activities: {deployed.ActivitiesCount}, Flows: {deployed.SequenceFlowsCount})";
            
            // Refresh the workflow list after successful upload
            await Task.Delay(1000); // Small delay to show success message
            await LoadWorkflows();
            HideUploadDialog();
        }
        catch (InvalidOperationException ex)
        {
            Logger.LogError(ex, "Invalid BPMN file");
            uploadErrorMessage = $"Invalid BPMN file: {ex.Message}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error uploading BPMN file");
            uploadErrorMessage = $"Failed to upload file: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }
}
