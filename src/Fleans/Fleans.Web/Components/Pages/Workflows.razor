@page "/workflows"
@rendermode InteractiveServer
@using Fleans.Application
@using Fleans.Domain
@using Microsoft.FluentUI.AspNetCore.Components
@inject WorkflowEngine WorkflowEngine
@inject NavigationManager Navigation
@inject ILogger<Workflows> Logger

<PageTitle>Workflows</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Gap="20px">
    <FluentStack Orientation="Orientation.Horizontal" Justify="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <FluentLabel Typo="Typography.PageTitle">Registered Workflows</FluentLabel>
        <FluentStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
            <FluentButton Appearance="Appearance.Accent" @onclick="NewWorkflow">
                <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Add())" />
                New Workflow
            </FluentButton>
            <FluentButton Appearance="Appearance.Neutral" @onclick="RefreshWorkflows" Disabled="@isLoading">
                <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowSync())" />
                Refresh
            </FluentButton>
        </FluentStack>
    </FluentStack>

    @if (isLoading && allDefinitions.Count == 0)
    {
        <FluentStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="10px">
            <FluentProgressRing />
            <FluentBodyText>Loading workflows...</FluentBodyText>
        </FluentStack>
    }
    else
    {
        @if (!string.IsNullOrWhiteSpace(loadErrorMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => loadErrorMessage = null)">
                <FluentStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
                    <span>@loadErrorMessage</span>
                    <FluentButton Appearance="Appearance.Neutral" @onclick="RefreshWorkflows" Disabled="@isLoading">
                        Retry
                    </FluentButton>
                </FluentStack>
            </FluentMessageBar>
        }

        @if (!string.IsNullOrWhiteSpace(actionErrorMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => actionErrorMessage = null)">
                @actionErrorMessage
            </FluentMessageBar>
        }

        @if (!string.IsNullOrWhiteSpace(actionSuccessMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Success" Dismissible="true" OnDismissed="@(() => actionSuccessMessage = null)">
                @actionSuccessMessage
            </FluentMessageBar>
        }

        @if (allDefinitions.Count == 0)
        {
            <FluentMessageBar Intent="MessageIntent.Info">
                <strong>No workflows found.</strong> Create a new workflow in the <a href="/editor">Editor</a>.
            </FluentMessageBar>
        }
        else
        {
            <FluentTextField Placeholder="Search by process key"
                             @bind-Value="SearchQuery"
                             Style="max-width: 320px;" />

            @if (filteredDefinitions.Count == 0)
            {
                <FluentMessageBar Intent="MessageIntent.Info">
                    No workflows match "@SearchQuery".
                </FluentMessageBar>
            }
            else
            {
                <FluentDataGrid Items="@filteredDefinitionsQueryable" TGridItem="ProcessDefinitionSummary">
                    <TemplateColumn Title="Process Key">
                        <strong title="@context.ProcessDefinitionId">@context.ProcessDefinitionKey</strong>
                    </TemplateColumn>
                    <TemplateColumn Title="Version">
                        <FluentBadge Color="Color.Accent">v@(context.Version)</FluentBadge>
                    </TemplateColumn>
                    <TemplateColumn Title="Deployed at (UTC)">
                        @context.DeployedAt.ToUniversalTime().ToString("u")
                    </TemplateColumn>
                    <TemplateColumn Title="Actions">
                        <FluentStack Orientation="Orientation.Horizontal" Gap="4px">
                            <FluentButton Appearance="Appearance.Stealth"
                                          @onclick="() => EditWorkflow(context)">
                                <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Edit())" />
                                Edit
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Stealth"
                                          @onclick="() => StartVersion(context)"
                                          Disabled="@isStarting">
                                @if (isStarting && startingProcessDefinitionId == context.ProcessDefinitionId)
                                {
                                    <FluentProgressRing Size="Size.Small" />
                                    <span style="margin-left: 8px;">Starting...</span>
                                }
                                else
                                {
                                    <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Play())" />
                                    <span style="margin-left: 8px;">Start</span>
                                }
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Stealth"
                                          @onclick="() => ViewInstances(context)">
                                <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.List())" />
                                Instances
                            </FluentButton>
                        </FluentStack>
                    </TemplateColumn>
                </FluentDataGrid>
            }
        }
    }
</FluentStack>

@code {
    private List<ProcessDefinitionSummary> allDefinitions = new();
    private List<ProcessDefinitionSummary> filteredDefinitions = new();
    private IQueryable<ProcessDefinitionSummary> filteredDefinitionsQueryable = Enumerable.Empty<ProcessDefinitionSummary>().AsQueryable();
    private bool isLoading = true;
    private string? loadErrorMessage;
    private string? actionErrorMessage;
    private string? actionSuccessMessage;
    private bool isStarting = false;
    private string? startingProcessDefinitionId;
    private string searchQuery = string.Empty;

    private string SearchQuery
    {
        get => searchQuery;
        set
        {
            if (searchQuery == value)
            {
                return;
            }

            searchQuery = value;
            ApplyFilter();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflows();
    }

    private async Task LoadWorkflows()
    {
        try
        {
            isLoading = true;
            loadErrorMessage = null;

            var definitions = await WorkflowEngine.GetAllProcessDefinitions();

            allDefinitions = definitions
                .OrderBy(d => d.ProcessDefinitionKey, StringComparer.Ordinal)
                .ThenByDescending(d => d.Version)
                .ToList();

            ApplyFilter();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading workflows");
            loadErrorMessage = "Unable to reach workflow engine. Try again.";
            if (allDefinitions.Count == 0)
            {
                filteredDefinitions.Clear();
                filteredDefinitionsQueryable = filteredDefinitions.AsQueryable();
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshWorkflows()
    {
        await LoadWorkflows();
    }

    private void NewWorkflow()
    {
        Navigation.NavigateTo("/editor");
    }

    private void EditWorkflow(ProcessDefinitionSummary definition)
    {
        Navigation.NavigateTo($"/editor/{Uri.EscapeDataString(definition.ProcessDefinitionKey)}");
    }

    private void ApplyFilter()
    {
        filteredDefinitions = allDefinitions
            .Where(d => string.IsNullOrWhiteSpace(SearchQuery)
                        || d.ProcessDefinitionKey.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase))
            .ToList();
        filteredDefinitionsQueryable = filteredDefinitions.AsQueryable();
    }

    private async Task StartVersion(ProcessDefinitionSummary version)
    {
        try
        {
            isStarting = true;
            startingProcessDefinitionId = version.ProcessDefinitionId;
            actionErrorMessage = null;
            actionSuccessMessage = null;

            var instanceId = await WorkflowEngine.StartWorkflowByProcessDefinitionId(version.ProcessDefinitionId);
            Logger.LogInformation("Process definition {ProcessDefinitionId} started successfully with instanceId {WorkflowInstanceId}", version.ProcessDefinitionId, instanceId);
            actionSuccessMessage = $"Started '{version.ProcessDefinitionKey}' v{version.Version}. Instance: {instanceId}.";
        }
        catch (KeyNotFoundException ex)
        {
            Logger.LogWarning("Failed to start process definition {ProcessDefinitionId}: {Error}", version.ProcessDefinitionId, ex.Message);
            actionErrorMessage = $"Failed to start workflow: {ex.Message}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting process definition {ProcessDefinitionId}", version.ProcessDefinitionId);
            actionErrorMessage = $"Failed to start workflow: {ex.Message}";
        }
        finally
        {
            isStarting = false;
            startingProcessDefinitionId = null;
        }
    }

    private void ViewInstances(ProcessDefinitionSummary version)
    {
        Navigation.NavigateTo($"/process-instances/{Uri.EscapeDataString(version.ProcessDefinitionKey)}");
    }
}
