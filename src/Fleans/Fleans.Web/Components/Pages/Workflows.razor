@page "/workflows"
@rendermode InteractiveServer
@using Fleans.Application
@using Fleans.Application.WorkflowFactory
@using Fleans.Infrastructure.Bpmn
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.FluentUI.AspNetCore.Components
@inject WorkflowEngine WorkflowEngine
@inject IBpmnConverter BpmnConverter
@inject ILogger<Workflows> Logger

<PageTitle>Workflows</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Gap="20px">
    <FluentStack Orientation="Orientation.Horizontal" Justify="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <FluentHeader HSize="HeadingSize.H1">Registered Workflows</FluentHeader>
        
        <FluentStack Orientation="Orientation.Vertical" Gap="20px">
            <FluentInputFile @ref="@myFileUploader" 
                             DragDropZoneVisible="false"
                             Mode="InputFileMode.SaveToTemporaryFolder"
                             Multiple="false"
                             AnchorId="MyUploadButton"
                             MaximumFileSize="@(10 * 1024 * 1024)"
                             Accept=".bpmn,.xml"
                             OnProgressChange="@(e =>
                                               {
                                                   uploadProgressPercent = e.ProgressPercent; 
                                                   uploadProgressTitle = e.ProgressTitle;
                                               })"
                             OnCompleted="@OnFileUploadCompleted" />

            <FluentProgress Min="0" Max="100" Visible="@(uploadProgressPercent > 0)" Value="@uploadProgressPercent" />
            @if (!string.IsNullOrEmpty(uploadProgressTitle))
            {
                <FluentLabel Alignment="HorizontalAlignment.Center">
                    @uploadProgressTitle
                </FluentLabel>
            }

            <FluentButton Id="MyUploadButton" Appearance="Appearance.Accent" Disabled="@isUploading">
                <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowUpload())" />
                <span style="margin-left: 8px;">Select BPMN File</span>
            </FluentButton>

            @if (uploadedFiles.Any())
            {
                <FluentStack Orientation="Orientation.Vertical" Gap="10px">
                    <FluentHeading HSize="HeadingSize.H4">Selected file:</FluentHeading>
                    @foreach (var file in uploadedFiles)
                    {
                        <FluentBodyText>
                            <strong>@file.Name</strong> • 
                            @($"{Decimal.Divide(file.Size, 1024):N} KB") • 
                            @file.ContentType
                            @if (!string.IsNullOrEmpty(file.ErrorMessage))
                            {
                                <FluentMessageBar Intent="MessageIntent.Error">@file.ErrorMessage</FluentMessageBar>
                            }
                        </FluentBodyText>
                    }
                    <FluentButton Appearance="Appearance.Accent" @onclick="HandleFileUpload" Disabled="@isUploading">
                        @if (isUploading)
                        {
                            <FluentProgressRing Size="Size.Small" />
                            <span style="margin-left: 8px;">Uploading...</span>
                        }
                        else
                        {
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowUpload())" />
                            <span style="margin-left: 8px;">Upload and Register Workflow</span>
                        }
                    </FluentButton>
                </FluentStack>
            }

            @if (uploadErrorMessage != null)
            {
                <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => uploadErrorMessage = null)">
                    @uploadErrorMessage
                </FluentMessageBar>
            }
            @if (uploadSuccessMessage != null)
            {
                <FluentMessageBar Intent="MessageIntent.Success" Dismissible="true" OnDismissed="@(() => uploadSuccessMessage = null)">
                    @uploadSuccessMessage
                </FluentMessageBar>
            }
        </FluentStack>
        
    </FluentStack>

    @if (isLoading)
    {
        <FluentStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="10px">
            <FluentProgressRing />
            <FluentBodyText>Loading workflows...</FluentBodyText>
        </FluentStack>
    }
    else if (errorMessage != null)
    {
        <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => errorMessage = null)">
            <strong>Error:</strong> @errorMessage
        </FluentMessageBar>
    }
    else if (workflows == null || !workflows.Any())
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            <strong>No workflows found.</strong> Upload a BPMN file to register a workflow.
        </FluentMessageBar>
    }
    else
    {
        <FluentTable Items="@workflows">
            <FluentTableHeader>
                <FluentTableRow>
                    <FluentTableHeaderCell>Workflow ID</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Activities</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Sequence Flows</FluentTableHeaderCell>
                    <FluentTableHeaderCell>Actions</FluentTableHeaderCell>
                </FluentTableRow>
            </FluentTableHeader>
            <FluentTableBody>
                @foreach (var workflow in workflows)
                {
                    <FluentTableRow>
                        <FluentTableCell>
                            <strong>@workflow.WorkflowId</strong>
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentBadge Color="Color.Accent">@workflow.ActivitiesCount</FluentBadge>
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentBadge Color="Color.Neutral">@workflow.SequenceFlowsCount</FluentBadge>
                        </FluentTableCell>
                        <FluentTableCell>
                            <FluentButton Appearance="Appearance.Stealth" @onclick="() => StartWorkflow(workflow.WorkflowId)" Disabled="@isStarting">
                                @if (isStarting && startingWorkflowId == workflow.WorkflowId)
                                {
                                    <FluentProgressRing Size="Size.Small" />
                                    <span style="margin-left: 8px;">Starting...</span>
                                }
                                else
                                {
                                    <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Play())" />
                                    <span style="margin-left: 8px;">Start</span>
                                }
                            </FluentButton>
                        </FluentTableCell>
                    </FluentTableRow>
                }
            </FluentTableBody>
        </FluentTable>

        <FluentButton Appearance="Appearance.Neutral" @onclick="RefreshWorkflows" Disabled="@isLoading">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowSync())" />
            Refresh
        </FluentButton>
    }
</FluentStack>



@code {
    private List<WorkflowSummary>? workflows;
    private bool isLoading = true;
    private string? errorMessage;
    private bool isStarting = false;
    private string? startingWorkflowId;
    private bool showUploadModal = false;
    private bool isUploading = false;
    private FluentInputFile? myFileUploader = default!;
    private int? uploadProgressPercent;
    private string? uploadProgressTitle;
    private FluentInputFileEventArgs[] uploadedFiles = Array.Empty<FluentInputFileEventArgs>();
    private string? uploadErrorMessage;
    private string? uploadSuccessMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflows();
    }

    private async Task LoadWorkflows()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var workflowsList = await WorkflowEngine.GetAllWorkflows();
            workflows = workflowsList?.ToList() ?? new List<WorkflowSummary>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading workflows");
            errorMessage = "Failed to load workflows. Please try again later.";
            workflows = new List<WorkflowSummary>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshWorkflows()
    {
        await LoadWorkflows();
    }

    private async Task StartWorkflow(string workflowId)
    {
        try
        {
            isStarting = true;
            startingWorkflowId = workflowId;

            var instanceId = await WorkflowEngine.StartWorkflow(workflowId);
            Logger.LogInformation("Workflow {WorkflowId} started successfully with instanceId {WorkflowInstanceId}", workflowId, instanceId);
            errorMessage = null;
        }
        catch (KeyNotFoundException ex)
        {
            Logger.LogWarning("Failed to start workflow {WorkflowId}: {Error}", workflowId, ex.Message);
            errorMessage = $"Failed to start workflow: {ex.Message}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting workflow {WorkflowId}", workflowId);
            errorMessage = $"Failed to start workflow: {ex.Message}";
        }
        finally
        {
            isStarting = false;
            startingWorkflowId = null;
        }
    }

    private void ShowUploadDialog()
    {
        showUploadModal = true;
        uploadErrorMessage = null;
        uploadSuccessMessage = null;
        uploadedFiles = Array.Empty<FluentInputFileEventArgs>();
        uploadProgressPercent = null;
        uploadProgressTitle = null;
        
        StateHasChanged();
    }

    private void HideUploadDialog()
    {
        showUploadModal = false;
        uploadErrorMessage = null;
        uploadSuccessMessage = null;
        uploadedFiles = Array.Empty<FluentInputFileEventArgs>();
        uploadProgressPercent = null;
        uploadProgressTitle = null;
        
        // Clean up temporary files
        foreach (var file in uploadedFiles)
        {
            file.LocalFile?.Delete();
        }
    }

    private void OnFileUploadCompleted(IEnumerable<FluentInputFileEventArgs> files)
    {
        uploadedFiles = files.ToArray();
        uploadProgressPercent = myFileUploader?.ProgressPercent;
        uploadProgressTitle = myFileUploader?.ProgressTitle;
        
        // Check for errors in uploaded files
        var errorFile = uploadedFiles.FirstOrDefault(f => !string.IsNullOrEmpty(f.ErrorMessage));
        if (errorFile != null)
        {
            uploadErrorMessage = errorFile.ErrorMessage;
        }
    }

    private async Task HandleFileUpload()
    {
        if (!uploadedFiles.Any())
        {
            uploadErrorMessage = "Please select a file to upload";
            return;
        }

        var file = uploadedFiles.First();
        
        if (!string.IsNullOrEmpty(file.ErrorMessage))
        {
            uploadErrorMessage = file.ErrorMessage;
            return;
        }

        try
        {
            isUploading = true;
            uploadErrorMessage = null;
            uploadSuccessMessage = null;

            // Validate file extension
            if (!file.Name.EndsWith(".bpmn", StringComparison.OrdinalIgnoreCase) &&
                !file.Name.EndsWith(".xml", StringComparison.OrdinalIgnoreCase))
            {
                uploadErrorMessage = "File must be a BPMN (.bpmn) or XML (.xml) file";
                return;
            }

            // Read file from temporary location
            if (file.LocalFile == null || !file.LocalFile.Exists)
            {
                uploadErrorMessage = "File not found. Please select the file again.";
                return;
            }

            using var fileStream = file.LocalFile.OpenRead();
            var workflow = await BpmnConverter.ConvertFromXmlAsync(fileStream);
            
            // Register workflow
            await WorkflowEngine.RegisterWorkflow(workflow);
            
            uploadSuccessMessage = $"BPMN file uploaded and workflow registered successfully (Workflow ID: {workflow.WorkflowId}, Activities: {workflow.Activities.Count}, Flows: {workflow.SequenceFlows.Count})";
            
            // Refresh the workflow list after successful upload
            await Task.Delay(1000); // Small delay to show success message
            await LoadWorkflows();
            HideUploadDialog();
        }
        catch (InvalidOperationException ex)
        {
            Logger.LogError(ex, "Invalid BPMN file");
            uploadErrorMessage = $"Invalid BPMN file: {ex.Message}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error uploading BPMN file");
            uploadErrorMessage = $"Failed to upload file: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }
}
