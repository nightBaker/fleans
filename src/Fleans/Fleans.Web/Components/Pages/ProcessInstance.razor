@page "/process-instance/{InstanceId:guid}"
@rendermode InteractiveServer
@using Fleans.Application
@using Fleans.Domain
@using Microsoft.FluentUI.AspNetCore.Components
@inject WorkflowEngine WorkflowEngine
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<ProcessInstance> Logger
@implements IAsyncDisposable

<PageTitle>Instance @InstanceId</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Gap="16px">
    <FluentStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="12px">
        <FluentButton Appearance="Appearance.Stealth" @onclick="GoBack">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowLeft())" />
            Back
        </FluentButton>
        <FluentHeader HSize="HeadingSize.H2">Process Instance</FluentHeader>
        @if (snapshot != null)
        {
            @if (snapshot.IsCompleted)
            {
                <FluentBadge Color="Color.Success">Completed</FluentBadge>
            }
            else if (snapshot.IsStarted)
            {
                <FluentBadge Color="Color.Accent">Running</FluentBadge>
            }
        }
    </FluentStack>

    <FluentBodyText><strong>Instance ID:</strong> @InstanceId</FluentBodyText>

    @if (isLoading)
    {
        <FluentStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="10px">
            <FluentProgressRing />
            <FluentBodyText>Loading instance...</FluentBodyText>
        </FluentStack>
    }
    else if (errorMessage != null)
    {
        <FluentMessageBar Intent="MessageIntent.Error">
            @errorMessage
        </FluentMessageBar>
    }
    else
    {
        <div id="bpmn-canvas" class="bpmn-container"></div>

        <FluentStack Orientation="Orientation.Horizontal" Gap="24px" Style="align-items: flex-start;">
            <FluentStack Orientation="Orientation.Vertical" Gap="8px" Style="flex: 1;">
                <FluentHeading HSize="HeadingSize.H4">Completed Activities</FluentHeading>
                @if (snapshot!.CompletedActivityIds.Count == 0)
                {
                    <FluentBodyText>None</FluentBodyText>
                }
                else
                {
                    @foreach (var id in snapshot.CompletedActivityIds)
                    {
                        <FluentStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.CheckmarkCircle())" Color="Color.Success" />
                            <FluentBodyText>@id</FluentBodyText>
                        </FluentStack>
                    }
                }
            </FluentStack>

            <FluentStack Orientation="Orientation.Vertical" Gap="8px" Style="flex: 1;">
                <FluentHeading HSize="HeadingSize.H4">Active Activities</FluentHeading>
                @if (snapshot!.ActiveActivityIds.Count == 0)
                {
                    <FluentBodyText>None</FluentBodyText>
                }
                else
                {
                    @foreach (var id in snapshot.ActiveActivityIds)
                    {
                        <FluentStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Circle())" Color="Color.Accent" />
                            <FluentBodyText>@id</FluentBodyText>
                        </FluentStack>
                    }
                }
            </FluentStack>
        </FluentStack>

        <FluentButton Appearance="Appearance.Neutral" @onclick="Refresh">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowSync())" />
            Refresh
        </FluentButton>
    }
</FluentStack>

@code {
    [Parameter] public Guid InstanceId { get; set; }

    private InstanceStateSnapshot? snapshot;
    private string? bpmnXml;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadInstance();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && bpmnXml != null)
        {
            await RenderDiagram();
        }
    }

    private async Task LoadInstance()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            snapshot = await WorkflowEngine.GetInstanceDetail(InstanceId);
            bpmnXml = await WorkflowEngine.GetBpmnXml(InstanceId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading instance {InstanceId}", InstanceId);
            errorMessage = $"Failed to load instance: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RenderDiagram()
    {
        if (bpmnXml == null || snapshot == null) return;

        await JS.InvokeVoidAsync("bpmnViewer.init", "bpmn-canvas", bpmnXml);
        await JS.InvokeVoidAsync("bpmnViewer.highlight", snapshot.CompletedActivityIds, snapshot.ActiveActivityIds);
    }

    private async Task Refresh()
    {
        await LoadInstance();
        StateHasChanged();
        await Task.Yield();
        if (snapshot != null)
        {
            await JS.InvokeVoidAsync("bpmnViewer.highlight", snapshot.CompletedActivityIds, snapshot.ActiveActivityIds);
        }
    }

    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("bpmnViewer.destroy");
        }
        catch
        {
            // JS interop may fail during disposal
        }
    }
}
