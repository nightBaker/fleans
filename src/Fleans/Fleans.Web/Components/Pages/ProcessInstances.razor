@page "/process-instances/{ProcessDefinitionKey}"
@page "/process-instances/{ProcessDefinitionKey}/{Version:int}"
@rendermode InteractiveServer
@using Fleans.Application
@using Fleans.Application.QueryModels
@using Microsoft.FluentUI.AspNetCore.Components
@inject IWorkflowQueryService QueryService
@inject NavigationManager Navigation
@inject ILogger<ProcessInstances> Logger

<PageTitle>Instances - @ProcessDefinitionKey</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Gap="16px">
    <PageHeader Title="@GetPageTitle()" GoBackUrl="/workflows" />

    @if (isLoading)
    {
        <FluentStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="10px">
            <FluentProgressRing />
            <p>Loading instances...</p>
        </FluentStack>
    }
    else if (errorMessage != null)
    {
        <FluentMessageBar Intent="MessageIntent.Error" Dismissible="true" OnDismissed="@(() => errorMessage = null)">
            @errorMessage
        </FluentMessageBar>
    }
    else if (instances.Count == 0)
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            No instances found for this process. Start a workflow to create one.
        </FluentMessageBar>
    }
    else
    {
        <FluentDataGrid Items="@instancesQueryable" TGridItem="WorkflowInstanceInfo">
            <TemplateColumn Title="Instance ID">
                <span title="@context.InstanceId">@context.InstanceId.ToString()[..8]...</span>
            </TemplateColumn>
            <TemplateColumn Title="Status">
                @if (context.IsCompleted)
                {
                    <FluentBadge Color="Color.Success">Completed</FluentBadge>
                }
                else if (context.IsStarted)
                {
                    <FluentBadge Color="Color.Accent">Running</FluentBadge>
                }
                else
                {
                    <FluentBadge Color="Color.Neutral">Pending</FluentBadge>
                }
            </TemplateColumn>
            <PropertyColumn Property="@(i => i.CreatedAt)" Title="Created At" Sortable="true" Format="yyyy-MM-dd HH:mm:ss" />
            <PropertyColumn Property="@(i => i.ExecutionStartedAt)" Title="Started At" Sortable="true" Format="yyyy-MM-dd HH:mm:ss" />
            <PropertyColumn Property="@(i => i.CompletedAt)" Title="Completed At" Sortable="true" Format="yyyy-MM-dd HH:mm:ss" />
            <TemplateColumn Title="Actions">
                <FluentButton Appearance="Appearance.Stealth"
                              IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Eye())"
                              @onclick="() => ViewInstance(context.InstanceId)">
                    View
                </FluentButton>
            </TemplateColumn>
        </FluentDataGrid>
    }
</FluentStack>

@code {
    [Parameter] public string ProcessDefinitionKey { get; set; } = string.Empty;
    [Parameter] public int? Version { get; set; }

    private List<WorkflowInstanceInfo> instances = new();
    private IQueryable<WorkflowInstanceInfo> instancesQueryable = Enumerable.Empty<WorkflowInstanceInfo>().AsQueryable();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadInstances();
    }

    private async Task LoadInstances()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            IReadOnlyList<WorkflowInstanceInfo> result;
            if (Version.HasValue)
                result = await QueryService.GetInstancesByKeyAndVersion(ProcessDefinitionKey, Version.Value);
            else
                result = await QueryService.GetInstancesByKey(ProcessDefinitionKey);
            instances = result.ToList();
            instancesQueryable = instances.AsQueryable();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading instances for {Key}", ProcessDefinitionKey);
            errorMessage = $"Failed to load instances: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetPageTitle()
    {
        if (Version.HasValue)
            return $"Instances \u2014 {ProcessDefinitionKey} v{Version}";
        return $"Instances \u2014 {ProcessDefinitionKey} (all versions)";
    }

    private void ViewInstance(Guid instanceId)
    {
        Navigation.NavigateTo($"/process-instance/{instanceId}");
    }
}
