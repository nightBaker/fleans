@page "/workflows"
@rendermode InteractiveServer
@using Fleans.Application.WorkflowFactory
@using System.Net.Http.Json
@using Fleans.ServiceDefaults.DTOs
@inject HttpClient Http
@inject ILogger<Workflows> Logger

<PageTitle>Workflows</PageTitle>

<div class="container-fluid">
    <h1>Registered Workflows</h1>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading workflows...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <strong>Error:</strong> @errorMessage
        </div>
    }
    else if (workflows == null || !workflows.Any())
    {
        <div class="alert alert-info" role="alert">
            <strong>No workflows found.</strong> Upload a BPMN file to register a workflow.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Workflow ID</th>
                        <th>Activities</th>
                        <th>Sequence Flows</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var workflow in workflows)
                    {
                        <tr>
                            <td>
                                <strong>@workflow.WorkflowId</strong>
                            </td>
                            <td>
                                <span class="badge bg-primary">@workflow.ActivitiesCount</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">@workflow.SequenceFlowsCount</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-success" @onclick="() => StartWorkflow(workflow.WorkflowId)" disabled="@isStarting">
                                    @if (isStarting && startingWorkflowId == workflow.WorkflowId)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                        <span>Starting...</span>
                                    }
                                    else
                                    {
                                        <span>Start</span>
                                    }
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            <button class="btn btn-primary" @onclick="RefreshWorkflows" disabled="@isLoading">
                <span class="bi bi-arrow-clockwise"></span> Refresh
            </button>
        </div>
    }
</div>

@code {
    private List<WorkflowSummary>? workflows;
    private bool isLoading = true;
    private string? errorMessage;
    private bool isStarting = false;
    private string? startingWorkflowId;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflows();
    }

    private async Task LoadWorkflows()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var response = await Http.GetFromJsonAsync<List<WorkflowSummary>>("/workflow/all");
            workflows = response ?? new List<WorkflowSummary>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading workflows");
            errorMessage = "Failed to load workflows. Please try again later.";
            workflows = new List<WorkflowSummary>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshWorkflows()
    {
        await LoadWorkflows();
    }

    private async Task StartWorkflow(string workflowId)
    {
        try
        {
            isStarting = true;
            startingWorkflowId = workflowId;

            var request = new StartWorkflowRequest(workflowId);
            var response = await Http.PostAsJsonAsync("/workflow/start", request);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<StartWorkflowResponse>();
                // Show success message or navigate to workflow instance page
                Logger.LogInformation("Workflow {WorkflowId} started successfully with instanceId {WorkflowInstanceId}", workflowId, result.WorkflowInstanceId);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Logger.LogWarning("Failed to start workflow {WorkflowId}: {Error}", workflowId, error);
                errorMessage = $"Failed to start workflow: {error}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting workflow {WorkflowId}", workflowId);
            errorMessage = $"Failed to start workflow: {ex.Message}";
        }
        finally
        {
            isStarting = false;
            startingWorkflowId = null;
        }
    }
}

